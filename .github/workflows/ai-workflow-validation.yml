name: 🤖 AI-Powered Workflow Validation

'on':
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      auto_fix:
        description: 'Auto-fix issues using AI'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write  # Required for auto-fix commits
  pull-requests: write  # Required for PR comments

jobs:
  ai-validation:
    name: 🧠 AI Workflow Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          # Install system dependencies
          sudo apt-get update && sudo apt-get install -y jq curl

          # Install Python dependencies
          python -m pip install --upgrade pip
          pip install pyyaml requests urllib3 numpy

      - name: Run AI-powered validation
        env:
          REDHAT_AI_API_KEY: ${{ secrets.REDHAT_AI_API_KEY }}
        run: |
          # Verify dependencies are available
          which jq || (echo "jq not found" && exit 1)

          # Check if target directory exists
          if [ ! -d ".github/workflows" ]; then
            echo "❌ Error: .github/workflows directory not found"
            exit 1
          fi

          # Use the wrapper script instead of calling Python directly
          AUTO_FIX_FLAG=""
          if [ "${{ github.event.inputs.auto_fix }}" = "true" ]; then
            AUTO_FIX_FLAG="--fix"
          fi

          # Call the wrapper script with proper parameters
          ./scripts/common/validate-workflows.sh \
            $AUTO_FIX_FLAG \
            .github/workflows/
      
      - name: Upload validation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-validation-report
          path: validation-report.json
      
      - name: Commit auto-fixes
        if: github.event.inputs.auto_fix == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .github/workflows/
            git commit -m "🤖 AI auto-fix: Resolve workflow validation issues
            
            - Applied AI-suggested fixes to workflow files
            - Backup files created with .backup extension
            - Report available in validation-report.json"
            git push
          else
            echo "No changes to commit"
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              const report = JSON.parse(fs.readFileSync('validation-report.json', 'utf8'));
              
              const comment = `## 🤖 AI Workflow Validation Report
              
              **Status**: ${report.status === 'passed' ? '✅ Passed' : '❌ Failed'}
              **Issues Found**: ${report.total_issues}
              
              ${report.total_issues > 0 ? 
                `### Issues Detected:
                ${report.issues.map(issue => `- ${issue}`).join('\n')}
                
                💡 **Suggestion**: Run the workflow with auto-fix enabled to automatically resolve these issues.` 
                : '🎉 All workflow files are valid!'}
              
              ---
              *Generated by AI-Powered Workflow Validator*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not read validation report:', error.message);
            }

  security-check:
    name: 🔒 Security Validation
    runs-on: ubuntu-latest
    needs: ai-validation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check for exposed secrets
        run: |
          echo "🔍 Scanning for exposed secrets in workflows..."

          # Look for actual hardcoded secrets (values, not references)
          HARDCODED_PATTERNS=(
            "password\s*[:=]\s*[\"'][^\"']{8,}[\"']"
            "token\s*[:=]\s*[\"'][^\"']{20,}[\"']"
            "key\s*[:=]\s*[\"'][^\"']{20,}[\"']"
            "secret\s*[:=]\s*[\"'][^\"']{8,}[\"']"
            "AKIA[0-9A-Z]{16}"
            "-----BEGIN.*PRIVATE KEY-----"
          )

          ISSUES_FOUND=false

          for pattern in "${HARDCODED_PATTERNS[@]}"; do
            if grep -r -E "$pattern" .github/workflows/ --include="*.yml" --include="*.yaml" | grep -v "secrets\." | grep -v "#"; then
              echo "⚠️ Potential hardcoded secret found matching pattern: $pattern"
              ISSUES_FOUND=true
            fi
          done

          if [[ "$ISSUES_FOUND" == "false" ]]; then
            echo "✅ No hardcoded secrets detected"
            echo "✅ All secret references use proper GitHub secrets or Vault paths"
          else
            echo "❌ Potential hardcoded secrets found - review above matches"
            exit 1
          fi
      
      - name: Validate secret references
        run: |
          echo "🔍 Checking secret references..."
          
          # Extract all secret references using a simpler approach
          find .github/workflows/ -name "*.yml" -o -name "*.yaml" | \
            xargs grep -h "secrets\." | \
            grep -o "secrets\.[A-Z_][A-Z0-9_]*" | \
            sed 's/secrets\.//' | \
            sort -u > /tmp/secrets_used.txt || echo "No secrets found"
          
          if [ -s /tmp/secrets_used.txt ]; then
            echo "📋 Secrets referenced in workflows:"
            cat /tmp/secrets_used.txt
            echo "✅ Ensure all these secrets are configured in repository settings"
          else
            echo "ℹ️ No secrets referenced in workflows"
          fi
