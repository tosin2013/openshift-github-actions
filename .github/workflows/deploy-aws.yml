name: Deploy OpenShift on AWS

on:
  workflow_dispatch:
    inputs:
      cluster_name:
        description: 'Cluster Name'
        required: true
        type: string
      region:
        description: 'AWS Region'
        required: true
        type: choice
        options:
          - us-east-1
          - us-east-2
          - us-west-1
          - us-west-2
          - eu-west-1
          - eu-central-1
          - ap-southeast-1
          - ap-northeast-1
      node_count:
        description: 'Worker Node Count'
        required: true
        default: '3'
        type: string
      instance_type:
        description: 'Worker Instance Type'
        required: true
        default: 'm5.xlarge'
        type: choice
        options:
          - m5.large
          - m5.xlarge
          - m5.2xlarge
          - m5.4xlarge
          - c5.large
          - c5.xlarge
          - c5.2xlarge
      openshift_version:
        description: 'OpenShift Version'
        required: true
        default: '4.18.0'
        type: string
      base_domain:
        description: 'Base Domain'
        required: true
        type: string
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name }}
  REGION: ${{ github.event.inputs.region }}
  NODE_COUNT: ${{ github.event.inputs.node_count }}
  INSTANCE_TYPE: ${{ github.event.inputs.instance_type }}
  OPENSHIFT_VERSION: ${{ github.event.inputs.openshift_version }}
  BASE_DOMAIN: ${{ github.event.inputs.base_domain }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      validation_status: ${{ steps.validate.outputs.status }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate inputs
        id: validate
        run: |
          ./scripts/common/validate-inputs.sh \
            --provider aws \
            --cluster-name "$CLUSTER_NAME" \
            --region "$REGION" \
            --node-count "$NODE_COUNT" \
            --instance-type "$INSTANCE_TYPE" \
            --base-domain "$BASE_DOMAIN"
          echo "status=success" >> $GITHUB_OUTPUT

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: needs.validate.outputs.validation_status == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install awscli boto3 jinja2 pyyaml

      - name: Authenticate to HashiCorp Vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_URL }}
          method: jwt
          jwtGithubAudience: ${{ secrets.VAULT_JWT_AUDIENCE }}
          role: ${{ secrets.VAULT_ROLE }}
          secrets: |
            aws/creds/openshift-installer access_key | AWS_ACCESS_KEY_ID ;
            aws/creds/openshift-installer secret_key | AWS_SECRET_ACCESS_KEY ;
            secret/data/openshift/pull-secret pullSecret | PULL_SECRET ;
            secret/data/openshift/ssh-keys/${{ env.ENVIRONMENT }} private_key | SSH_PRIVATE_KEY ;
            secret/data/openshift/ssh-keys/${{ env.ENVIRONMENT }} public_key | SSH_PUBLIC_KEY

      - name: Install OpenShift CLI
        run: |
          mkdir -p ~/bin
          curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${{ env.OPENSHIFT_VERSION }}/openshift-client-linux.tar.gz | tar xz -C ~/bin
          curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/${{ env.OPENSHIFT_VERSION }}/openshift-install-linux.tar.gz | tar xz -C ~/bin
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Validate AWS credentials
        run: |
          aws sts get-caller-identity
          aws ec2 describe-regions --region ${{ env.REGION }}

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          echo "$SSH_PUBLIC_KEY" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Generate install-config.yaml
        run: |
          ./scripts/common/generate-install-config.sh \
            --provider aws \
            --cluster-name "$CLUSTER_NAME" \
            --region "$REGION" \
            --node-count "$NODE_COUNT" \
            --instance-type "$INSTANCE_TYPE" \
            --base-domain "$BASE_DOMAIN" \
            --environment "$ENVIRONMENT"

      - name: Create installation manifests
        run: |
          mkdir -p installation-dir
          cp install-config.yaml installation-dir/
          openshift-install create manifests --dir=installation-dir

      - name: Deploy OpenShift Cluster
        run: |
          openshift-install create cluster --dir=installation-dir --log-level=info

      - name: Save cluster credentials
        run: |
          ./scripts/common/save-cluster-credentials.sh \
            --provider aws \
            --cluster-name "$CLUSTER_NAME" \
            --region "$REGION" \
            --environment "$ENVIRONMENT"

      - name: Configure cluster
        run: |
          export KUBECONFIG=installation-dir/auth/kubeconfig
          ./scripts/common/configure-cluster.sh \
            --provider aws \
            --cluster-name "$CLUSTER_NAME" \
            --environment "$ENVIRONMENT"

      - name: Validate deployment
        run: |
          export KUBECONFIG=installation-dir/auth/kubeconfig
          ./tests/validation/validate-cluster.sh \
            --provider aws \
            --cluster-name "$CLUSTER_NAME"

      - name: Upload installation logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: aws-installation-logs-${{ env.CLUSTER_NAME }}
          path: installation-dir/.openshift_install.log

      - name: Upload kubeconfig
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: aws-kubeconfig-${{ env.CLUSTER_NAME }}
          path: installation-dir/auth/kubeconfig

      - name: Cleanup on failure
        if: failure()
        run: |
          ./scripts/aws/cleanup-failed-deployment.sh \
            --cluster-name "$CLUSTER_NAME" \
            --region "$REGION"
